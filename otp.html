<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8">
<title>Follow @danie_lung</title>
<style>
    body {font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji"; background: #f7f7fb; color: #0f172a; padding: 16px;}
    h1 {color: #0f172a; font-size: 20px; font-weight: 700; margin: 0 0 12px 0;}
    p {font-family: ui-sans-serif, system-ui; color: #475569;}
    .container {background: #ffffff; padding: 16px; border-radius: 12px; max-width: 40rem; margin: auto; box-shadow: 0 6px 24px rgba(15, 23, 42, 0.06); border: 1px solid #eef2f7;}
    input[type="file"], input[type="text"] {margin-top: 8px; padding: 10px 12px; font-family: ui-sans-serif, system-ui; border: 1px solid #e2e8f0; border-radius: 10px; background: #f8fafc; width: 100%; box-sizing: border-box; outline: none; transition: border-color .15s ease, box-shadow .15s ease;}
    input[type="text"]::placeholder {color: #94a3b8;}
    input[type="file"]:focus, input[type="text"]:focus {border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59,130,246,.15); background: #fff;}
    #output {background: #0b1220; color: #7cfcc6; padding: 14px; border-radius: 10px; margin-top: 14px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; white-space: pre-wrap; max-height: 360px; overflow-y: auto; border: 1px solid #0f1a33;}
    button {margin-top: 12px; padding: 10px 14px; background: #111827; color: white; border: 0; border-radius: 10px; cursor: pointer; font-weight: 600; letter-spacing: .2px; transition: transform .05s ease, background .2s ease, box-shadow .2s ease; box-shadow: 0 6px 16px rgba(2,6,23,.12);} 
    button:hover {background: #0b1220;}
    button:active {transform: translateY(1px);} 
    .radio-group {display: flex; gap: 10px; margin: 8px 0 2px 0; flex-wrap: wrap; align-items: center;}
    .radio-group p {margin: 0 8px 0 0; font-size: 13px; color: #334155;}
    .radio-group label {display: inline-flex; align-items: center; gap: 8px; cursor: pointer; transition: .15s ease; background: #f1f5f9; padding: 6px 10px; border-radius: 9999px; border: 1px solid #e2e8f0; font-size: 13px; color: #0f172a;}
    .radio-group label:hover {background: #e2e8f0;}
    .radio-group input[type="radio"] {accent-color: #111827; transform: scale(1.05);} 
    hr {border: 0; height: 1px; background: #eef2f7; margin: 14px 0;}
    .section-title {font-size: 13px; font-weight: 700; color: #0f172a; margin: 0 0 6px 0; text-transform: uppercase; letter-spacing: .08em;}
</style>
</head>
<body>
<div class="container">
	<h1>‚≠ê Bookmarklet Kode OTP</h1>
    <hr>
    <h3 style="margin-bottom: 5px">üëâ Generator Bookmarklet</h3>
	<p style="margin-top:0">Bookmarklet ini berfungsi untuk menghasilkan kode OTP sesuai secret yang Anda masukkan. Kode OTP akan langsung terisi sesuai penggunaan OTP yang Anda buat.</p>
    <input type="text" id="bookmarkletCode" placeholder="Masukkan Kode Secret">
	<input type="text" id="bookmarkletNama" placeholder="Masukkan Nama Bookmarklet">
	<div class="radio-group">
		<p style="font-family: monospace, sans-serif;margin:0">Pilih Penggunaan OTP:</p>
		<label><input type="radio" name="bmOption" value="kode2fa" checked> Dapodik</label>
		<label><input type="radio" name="bmOption" value="infogtk"> InfoGtk</label>
	</div>
    <button onclick="generateBookmarklet()">Generate Bookmarklet</button>
    <p style="margin: 24px 0;font-family: monospace, sans-serif">Bookmarklet: <a id="bookmarkletLink" href="#" target="_blank"></a></p>
	<hr>
    <h3 style="margin-bottom: 5px">üëâ Google Authenticator QR Decoder</h3>
    <p style="margin-top:0">Unggah gambar kode QR 2FA untuk mengekstrak akun dan secret-nya. Atau Anda bisa langsung menggunakan Generator Bookmarklet diatas jika sudah punya kode secret.</p>
    <input type="file" id="fileInput" accept="image/*">
    <pre id="output">Silakan Upload QR Google Authenticator</pre>
</div>

<script src="https://cdn.jsdelivr.net/npm/protobufjs/dist/protobuf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jsqr/dist/jsQR.js"></script>
<script>
document.getElementById('fileInput').addEventListener('change', handleFile);

function handleFile(evt) {
    const file = evt.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function(e) {
        const img = new Image();
        img.onload = function() {
            const canvas = document.createElement('canvas');
            canvas.width = img.width;
            canvas.height = img.height;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0);
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const code = jsQR(imageData.data, imageData.width, imageData.height);

            if (code) {
                processQR(code.data);
            } else {
                document.getElementById('output').textContent = "‚ùå QR code tidak terbaca.";
            }
        };
        img.src = e.target.result;
    };
    reader.readAsDataURL(file);
}

function processQR(qrText) {
    try {
        if (qrText.startsWith("otpauth://")) {
            const url = new URL(qrText);
            const secret = url.searchParams.get("secret");
            const issuer = url.searchParams.get("issuer") || "(tidak ada)";
            const label = decodeURIComponent(url.pathname.replace(/^\/\//, ''));
            if (secret) {
                document.getElementById('output').textContent =
                    `üìå OTP Auth\n` +
                    `Nama   : ${label}\n` +
                    `Issuer : ${issuer}\n` +
                    `Secret : ${secret}`;
                const secretInput = document.getElementById('bookmarkletCode');
                if (secretInput) secretInput.value = secret;
            } else {
                document.getElementById('output').textContent = "‚ö†Ô∏è Secret tidak ditemukan di QR.";
            }
            return;
        }
        const url = new URL(qrText);
        let dataParam = url.searchParams.get("data");

        if (!dataParam) {
            document.getElementById('output').textContent = "‚ö†Ô∏è Parameter data= tidak ditemukan.";
            return;
        }

        dataParam = dataParam.replace(/ /g, '+').replace(/%20/g, '+').replace(/%2B/gi, '+');

        const binary = atob(dataParam);
        const bytes = new Uint8Array(binary.length);
        for (let i = 0; i < binary.length; i++) {
            bytes[i] = binary.charCodeAt(i);
        }

        const root = protobuf.Root.fromJSON({
            nested: {
                MigrationPayload: {
                    fields: {
                        otpParameters: { rule: "repeated", type: "OtpParameters", id: 1 },
                        version: { type: "int32", id: 2 },
                        batchSize: { type: "int32", id: 3 },
                        batchIndex: { type: "int32", id: 4 },
                        batchId: { type: "bytes", id: 5 }
                    }
                },
                OtpParameters: {
                    fields: {
                        secret: { type: "bytes", id: 1 },
                        name: { type: "string", id: 2 },
                        issuer: { type: "string", id: 3 },
                        algorithm: { type: "int32", id: 4 },
                        digits: { type: "int32", id: 5 },
                        type: { type: "int32", id: 6 },
                        counter: { type: "int64", id: 7 }
                    }
                }
            }
        });

        const MigrationPayload = root.lookupType("MigrationPayload");
        const payload = MigrationPayload.decode(bytes);

        if (!payload.otpParameters || payload.otpParameters.length === 0) {
            document.getElementById('output').textContent = "‚ö†Ô∏è Tidak ada akun ditemukan di payload migrasi.";
            return;
        }

        let result = "";
        let firstSecretBase32 = null;
        payload.otpParameters.forEach((param, i) => {
            const secretBase32 = base32Encode(param.secret);
            if (firstSecretBase32 === null) firstSecretBase32 = secretBase32;
            result += `üìå Akun ${i+1}\n`;
            result += `Nama   : ${param.name}\n`;
            result += `Issuer : ${param.issuer}\n`;
            result += `Secret : ${secretBase32}\n\n`;
        });

        document.getElementById('output').textContent = result;
        if (firstSecretBase32) {
            const secretInput = document.getElementById('bookmarkletCode');
            if (secretInput) secretInput.value = firstSecretBase32;
        }
    } catch (err) {
        document.getElementById('output').textContent = "‚ùå Error: " + err.message;
    }
}

function base32Encode(bytes) {
    const alphabet = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ234567';
    let bits = 0, value = 0, output = '';
    for (let i = 0; i < bytes.length; i++) {
        value = (value << 8) | bytes[i];
        bits += 8;
        while (bits >= 5) {
            output += alphabet[(value >>> (bits - 5)) & 31];
            bits -= 5;
        }
    }
    if (bits > 0) {
        output += alphabet[(value << (5 - bits)) & 31];
    }
    return output;
}

function generateBookmarklet() {
    const code = document.getElementById("bookmarkletCode").value.trim();
	const namacode = document.getElementById("bookmarkletNama").value.trim();
	const selected2fa = document.querySelector('input[name="bmOption"]:checked').value;

	let jsCode;
	if (selected2fa === "infogtk") {
		// Fill 6 inputs with class .otp-input inside form#otpForm
		jsCode = `var secretKey="${code}";function base32Decode(e){for(var t=e.toUpperCase().replace(/=+$/,"").replace(/\\s+/g,""),r=0,n=0,a=[],o=0;o<t.length;o++){var c="ABCDEFGHIJKLMNOPQRSTUVWXYZ234567".indexOf(t[o]);if(-1===c)throw new Error("Invalid Base32 character: "+t[o]);n=n<<5|c,(r+=5)>=8&&(a.push(n>>>r-8&255),r-=8)}return new Uint8Array(a)}function intToBuffer(e){var t=new ArrayBuffer(8),r=new DataView(t),n=Math.floor(e/Math.pow(2,32)),a=e>>>0;return r.setUint32(0,n),r.setUint32(4,a),new Uint8Array(t)}function generateTOTP(e,t,r,n){t=t||6,r=r||30,n=n||"SHA-1";var a=base32Decode(e),o=Math.floor(Date.now()/1e3),c=intToBuffer(Math.floor(o/r));return crypto.subtle.importKey("raw",a,{name:"HMAC",hash:{name:n}},!1,["sign"]).then(function(e){return crypto.subtle.sign("HMAC",e,c)}).then(function(e){var r=new Uint8Array(e),n=15&r[r.length-1];return(((127&r[n])<<24|(255&r[n+1])<<16|(255&r[n+2])<<8|255&r[n+3])%Math.pow(10,t)).toString().padStart(t,"0")})}function fillOTPForm(otp){var f=document.getElementById("otpForm");if(!f)return;var ins=f.querySelectorAll(".otp-input");if(ins.length===6&&otp.length===6){for(var i=0;i<6;i++){ins[i].value=otp.charAt(i)}}}generateTOTP(secretKey).then(function(code){fillOTPForm(code)}).catch(function(err){alert("Error: "+err.message)});`;
	} else {
		// Default Dapodik: fill single element by id 'kode2fa'
		jsCode = `var secretKey="${code}";function base32Decode(e){for(var t=e.toUpperCase().replace(/=+$/,"").replace(/\\s+/g,""),r=0,n=0,a=[],o=0;o<t.length;o++){var c="ABCDEFGHIJKLMNOPQRSTUVWXYZ234567".indexOf(t[o]);if(-1===c)throw new Error("Invalid Base32 character: "+t[o]);n=n<<5|c,(r+=5)>=8&&(a.push(n>>>r-8&255),r-=8)}return new Uint8Array(a)}function intToBuffer(e){var t=new ArrayBuffer(8),r=new DataView(t),n=Math.floor(e/Math.pow(2,32)),a=e>>>0;return r.setUint32(0,n),r.setUint32(4,a),new Uint8Array(t)}function generateTOTP(e,t,r,n){t=t||6,r=r||30,n=n||"SHA-1";var a=base32Decode(e),o=Math.floor(Date.now()/1e3),c=intToBuffer(Math.floor(o/r));return crypto.subtle.importKey("raw",a,{name:"HMAC",hash:{name:n}},!1,["sign"]).then(function(e){return crypto.subtle.sign("HMAC",e,c)}).then(function(e){var r=new Uint8Array(e),n=15&r[r.length-1];return(((127&r[n])<<24|(255&r[n+1])<<16|(255&r[n+2])<<8|255&r[n+3])%Math.pow(10,t)).toString().padStart(t,"0")})}generateTOTP(secretKey).then(function(e){var el=document.getElementById("kode2fa");if(el)el.value=e}).catch(function(e){alert("Error: "+e.message)});`;
	}

    if (!code) {
		alert("Masukkan kode secret terlebih dahulu.");
        return;
    } else if (!namacode) {
		alert("Masukkan nama bookmark terlebih dahulu.");
		return;
	}
    const bookmarklet = "javascript:(function(){" + encodeURIComponent(jsCode) + "})();";
    const link = document.getElementById("bookmarkletLink");
    link.href = bookmarklet;
    link.textContent = document.getElementById("bookmarkletNama").value;
}
</script>
</body>
</html>