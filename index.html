<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8">
<title>Bookmarklet</title>
<script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
</head>
<body class="bg-gray-50">
<div class="max-w-4xl mx-auto mt-10 bg-white rounded-xl shadow-lg p-6">
  <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
    <!-- Kolom Kiri: Google Authenticator QR Decoder -->
    <div class="space-y-4">
      <h3 class="text-base font-semibold text-gray-700">Google Authenticator QR Decoder</h3>
      <p class="text-xs text-gray-600">Unggah gambar QR 2FA untuk mengekstrak akun dan secret-nya.</p>
      <input type="file" id="fileInput" accept="image/*" class="w-full px-2 py-1 border rounded focus:ring focus:ring-blue-400 text-sm">
      <pre id="output" class="p-2 bg-gray-900 text-green-400 rounded h-24 overflow-y-auto border text-xs">Silakan Upload QR Google Authenticator</pre>
    </div>
    <!-- Kolom Kanan: Generator Bookmarklet -->
    <div class="space-y-4">
      <h3 class="text-base font-semibold text-gray-700">Generator Bookmarklet</h3>
      <p class="text-xs text-gray-600">Bookmarklet ini menghasilkan kode OTP sesuai secret yang Anda masukkan.</p>
      <div class="space-y-2">Bookmarklet Kode OTP

        <!-- Ganti bagian input secret -->
        <div class="relative">
          <input type="password" id="bookmarkletCode" placeholder="Kode Secret" class="w-full px-2 py-1 border rounded focus:ring focus:ring-blue-400 text-sm">
          <button type="button" onclick="toggleSecret()" class="absolute right-2 top-1/2 -translate-y-1/2 text-xs text-gray-500">üëÅÔ∏è</button>
        </div>
        <script>
        function toggleSecret() {
          const input = document.getElementById('bookmarkletCode');
          if (input.type === 'password') {
            input.type = 'text';
          } else {
            input.type = 'password';
          }
        }
        </script>
        <input type="text" id="bookmarkletNama" placeholder="Nama Bookmarklet" class="w-full px-2 py-1 border rounded focus:ring focus:ring-blue-400 text-sm">
      </div>
      <div class="flex items-center gap-2 text-xs">
        <span class="text-gray-500">Penggunaan OTP:</span>
        <label class="flex items-center gap-1"><input type="radio" name="bmOption" value="kode2fa" checked> Dapodik</label>
        <label class="flex items-center gap-1"><input type="radio" name="bmOption" value="infogtk"> InfoGtk</label>
      </div>
      <button onclick="generateBookmarklet()" class="w-full py-2 bg-blue-600 text-white rounded hover:bg-blue-700 focus:ring focus:ring-blue-400 text-sm">Generate</button>
      <p class="text-xs text-gray-500">Bookmarklet: <a id="bookmarkletLink" href="#" target="_blank" class="text-blue-600 hover:underline"></a></p>
    </div>
  </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/protobufjs/dist/protobuf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jsqr/dist/jsQR.js"></script>
<script>
document.getElementById('fileInput').addEventListener('change', handleFile);

function handleFile(evt) {
    const file = evt.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function(e) {
        const img = new Image();
        img.onload = function() {
            const canvas = document.createElement('canvas');
            canvas.width = img.width;
            canvas.height = img.height;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0);
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const code = jsQR(imageData.data, imageData.width, imageData.height);

            if (code) {
                processQR(code.data);
            } else {
                document.getElementById('output').textContent = "‚ùå QR code tidak terbaca.";
            }
        };
        img.src = e.target.result;
    };
    reader.readAsDataURL(file);
}

function processQR(qrText) {
    try {
        if (qrText.startsWith("otpauth://")) {
            const url = new URL(qrText);
            const secret = url.searchParams.get("secret");
            const issuer = url.searchParams.get("issuer") || "(tidak ada)";
            const label = decodeURIComponent(url.pathname.replace(/^\/\//, ''));
            if (secret) {
                document.getElementById('output').textContent =
                    `üìå OTP Auth\n` +
                    `Nama   : ${label}\n` +
                    `Issuer : ${issuer}\n` +
                    `Secret : ${secret}`;
                const secretInput = document.getElementById('bookmarkletCode');
                if (secretInput) secretInput.value = secret;
            } else {
                document.getElementById('output').textContent = "‚ö†Ô∏è Secret tidak ditemukan di QR.";
            }
            return;
        }
        const url = new URL(qrText);
        let dataParam = url.searchParams.get("data");

        if (!dataParam) {
            document.getElementById('output').textContent = "‚ö†Ô∏è Parameter data= tidak ditemukan.";
            return;
        }

        dataParam = dataParam.replace(/ /g, '+').replace(/%20/g, '+').replace(/%2B/gi, '+');

        const binary = atob(dataParam);
        const bytes = new Uint8Array(binary.length);
        for (let i = 0; i < binary.length; i++) {
            bytes[i] = binary.charCodeAt(i);
        }

        const root = protobuf.Root.fromJSON({
            nested: {
                MigrationPayload: {
                    fields: {
                        otpParameters: { rule: "repeated", type: "OtpParameters", id: 1 },
                        version: { type: "int32", id: 2 },
                        batchSize: { type: "int32", id: 3 },
                        batchIndex: { type: "int32", id: 4 },
                        batchId: { type: "bytes", id: 5 }
                    }
                },
                OtpParameters: {
                    fields: {
                        secret: { type: "bytes", id: 1 },
                        name: { type: "string", id: 2 },
                        issuer: { type: "string", id: 3 },
                        algorithm: { type: "int32", id: 4 },
                        digits: { type: "int32", id: 5 },
                        type: { type: "int32", id: 6 },
                        counter: { type: "int64", id: 7 }
                    }
                }
            }
        });

        const MigrationPayload = root.lookupType("MigrationPayload");
        const payload = MigrationPayload.decode(bytes);

        if (!payload.otpParameters || payload.otpParameters.length === 0) {
            document.getElementById('output').textContent = "‚ö†Ô∏è Tidak ada akun ditemukan di payload migrasi.";
            return;
        }

        let result = "";
        let firstSecretBase32 = null;
        payload.otpParameters.forEach((param, i) => {
            const secretBase32 = base32Encode(param.secret);
            if (firstSecretBase32 === null) firstSecretBase32 = secretBase32;
            result += `üìå Akun ${i+1}\n`;
            result += `Nama   : ${param.name}\n`;
            result += `Issuer : ${param.issuer}\n`;
            result += `Secret : ${secretBase32}\n\n`;
        });

        document.getElementById('output').textContent = result;
        if (firstSecretBase32) {
            const secretInput = document.getElementById('bookmarkletCode');
            if (secretInput) secretInput.value = firstSecretBase32;
        }
    } catch (err) {
        document.getElementById('output').textContent = "‚ùå Error: " + err.message;
    }
}

function base32Encode(bytes) {
    const alphabet = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ234567';
    let bits = 0, value = 0, output = '';
    for (let i = 0; i < bytes.length; i++) {
        value = (value << 8) | bytes[i];
        bits += 8;
        while (bits >= 5) {
            output += alphabet[(value >>> (bits - 5)) & 31];
            bits -= 5;
        }
    }
    if (bits > 0) {
        output += alphabet[(value << (5 - bits)) & 31];
    }
    return output;
}

function generateBookmarklet() {
    const code = document.getElementById("bookmarkletCode").value.trim();
	const namacode = document.getElementById("bookmarkletNama").value.trim();
	const selected2fa = document.querySelector('input[name="bmOption"]:checked').value;

	let jsCode;
	if (selected2fa === "infogtk") {
		// Fill 6 inputs with class .otp-input inside form#otpForm
		jsCode = `var secretKey="${code}";function base32Decode(e){for(var t=e.toUpperCase().replace(/=+$/,"").replace(/\\s+/g,""),r=0,n=0,a=[],o=0;o<t.length;o++){var c="ABCDEFGHIJKLMNOPQRSTUVWXYZ234567".indexOf(t[o]);if(-1===c)throw new Error("Invalid Base32 character: "+t[o]);n=n<<5|c,(r+=5)>=8&&(a.push(n>>>r-8&255),r-=8)}return new Uint8Array(a)}function intToBuffer(e){var t=new ArrayBuffer(8),r=new DataView(t),n=Math.floor(e/Math.pow(2,32)),a=e>>>0;return r.setUint32(0,n),r.setUint32(4,a),new Uint8Array(t)}function generateTOTP(e,t,r,n){t=t||6,r=r||30,n=n||"SHA-1";var a=base32Decode(e),o=Math.floor(Date.now()/1e3),c=intToBuffer(Math.floor(o/r));return crypto.subtle.importKey("raw",a,{name:"HMAC",hash:{name:n}},!1,["sign"]).then(function(e){return crypto.subtle.sign("HMAC",e,c)}).then(function(e){var r=new Uint8Array(e),n=15&r[r.length-1];return(((127&r[n])<<24|(255&r[n+1])<<16|(255&r[n+2])<<8|255&r[n+3])%Math.pow(10,t)).toString().padStart(t,"0")})}function fillOTPForm(otp){var f=document.getElementById("otpForm");if(!f)return;var ins=f.querySelectorAll(".otp-input");if(ins.length===6&&otp.length===6){for(var i=0;i<6;i++){ins[i].value=otp.charAt(i)}}}generateTOTP(secretKey).then(function(code){fillOTPForm(code)}).catch(function(err){alert("Error: "+err.message)});`;
	} else {
		// Default Dapodik: fill single element by id 'kode2fa'
		jsCode = `var secretKey="${code}";function base32Decode(e){for(var t=e.toUpperCase().replace(/=+$/,"").replace(/\\s+/g,""),r=0,n=0,a=[],o=0;o<t.length;o++){var c="ABCDEFGHIJKLMNOPQRSTUVWXYZ234567".indexOf(t[o]);if(-1===c)throw new Error("Invalid Base32 character: "+t[o]);n=n<<5|c,(r+=5)>=8&&(a.push(n>>>r-8&255),r-=8)}return new Uint8Array(a)}function intToBuffer(e){var t=new ArrayBuffer(8),r=new DataView(t),n=Math.floor(e/Math.pow(2,32)),a=e>>>0;return r.setUint32(0,n),r.setUint32(4,a),new Uint8Array(t)}function generateTOTP(e,t,r,n){t=t||6,r=r||30,n=n||"SHA-1";var a=base32Decode(e),o=Math.floor(Date.now()/1e3),c=intToBuffer(Math.floor(o/r));return crypto.subtle.importKey("raw",a,{name:"HMAC",hash:{name:n}},!1,["sign"]).then(function(e){return crypto.subtle.sign("HMAC",e,c)}).then(function(e){var r=new Uint8Array(e),n=15&r[r.length-1];return(((127&r[n])<<24|(255&r[n+1])<<16|(255&r[n+2])<<8|255&r[n+3])%Math.pow(10,t)).toString().padStart(t,"0")})}generateTOTP(secretKey).then(function(e){var el=document.getElementById("kode2fa");if(el)el.value=e}).catch(function(e){alert("Error: "+e.message)});`;
	}

    if (!code) {
		alert("Masukkan kode secret terlebih dahulu.");
        return;
    } else if (!namacode) {
		alert("Masukkan nama bookmark terlebih dahulu.");
		return;
	}
    const bookmarklet = "javascript:(function(){" + encodeURIComponent(jsCode) + "})();";
    const link = document.getElementById("bookmarkletLink");
    link.href = bookmarklet;
    link.textContent = document.getElementById("bookmarkletNama").value;
}
</script>
</body>
</html>