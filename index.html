<!DOCTYPE html>
<html lang="id" class="scroll-smooth">
<head>
<meta charset="utf-8">
<title>Bookmarklet</title>
<script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
<style>
    .instagram-icon {
    transition: all 0.3s ease;
    filter: grayscale(100%);
  }
  
  .instagram-link:hover .instagram-icon {
    filter: grayscale(0%);
    transform: scale(1.1);
  }
  
  .instagram-link:hover {
    color: #e1306c !important;
  }
  
  .dark .instagram-link:hover {
    color: #e1306c !important;
  }
  .dark { background-color:#111827; }
  .dark .bg-gray-50 { background-color:#111827; }
  .dark .bg-white { background-color:#1f2937; }
  .dark .text-gray-800 { color:#f3f4f6; }
  .dark .text-gray-700 { color:#e5e7eb; }
  .dark .text-gray-600 { color:#d1d5db; }
  .dark .text-gray-500 { color:#9ca3af; }
  .dark .border-gray-200 { border-color:#374151; }
  .dark .border-gray-800 { border-color:#1f2937; }
  .dark .bg-gray-900 { background-color:#111827; }
  .dark .text-green-400 { color:#34d399; }
  .dark .bg-blue-600 { background-color:#2563eb; }
  .dark .hover\:bg-blue-700:hover { background-color:#1d4ed8; }
  .dark .bg-black\/50 { background-color:rgba(0,0,0,0.7); }
  .dark .accent-blue-600 { accent-color:#2563eb; }
  .dark .shadow-md { box-shadow:0 4px 6px -1px rgba(0,0,0,0.4),0 2px 4px -2px rgba(0,0,0,0.4); }
  .dark .shadow-sm { box-shadow:0 1px 2px 0 rgba(0,0,0,0.3); }
  .dark .shadow-lg { box-shadow:0 10px 15px -3px rgba(0,0,0,0.4),0 4px 6px -4px rgba(0,0,0,0.4); }
  .dark .from-blue-600 { --tw-gradient-from:#2563eb; --tw-gradient-to:#2563eb00; --tw-gradient-stops:var(--tw-gradient-from),var(--tw-gradient-to); }
  .dark .to-indigo-600 { --tw-gradient-to:#4f46e5; }
  .dark .hover\:from-blue-700:hover { --tw-gradient-from:#1d4ed8; --tw-gradient-to:#1d4ed800; --tw-gradient-stops:var(--tw-gradient-from),var(--tw-gradient-to); }
  .dark .hover\:to-indigo-700:hover { --tw-gradient-to:#4338ca; }
  .dark .text-blue-600 { color:#2563eb; }
  .dark .hover\:text-blue-700:hover { color:#1d4ed8; }
  .dark .text-gray-900 { color:#f9fafb; }
  .dark .text-gray-200 { color:#e5e7eb; }
  .dark .text-gray-300 { color:#d1d5db; }
  .dark .text-gray-400 { color:#9ca3af; }
  .dark .bg-gray-800 { background-color:#1f2937; }
  .dark .border-gray-300 { border-color:#4b5563; }
  .dark .focus\:ring-blue-400:focus { --tw-ring-color:#60a5fa; }
  .dark .placeholder-gray-400::placeholder { color:#9ca3af; }
</style>
</head>
<body class="bg-gray-50 text-gray-800 transition-colors duration-300">
<div class="max-w-5xl mx-auto mt-6 bg-white rounded-xl shadow-md p-4 md:p-6 transition-all duration-300">
  <div class="mb-4 flex items-center justify-between">
    <h1 class="text-lg font-semibold tracking-tight text-gray-800">OTP Tools</h1>
    <div class="flex items-center gap-3">
      <span class="text-[11px] text-gray-500">Tailwind 4</span>
      <button id="themeToggle" aria-label="Toggle Dark Mode" class="p-2 rounded-lg bg-gray-100 hover:bg-gray-200 dark:bg-gray-700 dark:hover:bg-gray-600 transition-all duration-200">
        <span class="dark:hidden">üåô</span>
        <span class="hidden dark:inline">‚òÄÔ∏è</span>
      </button>
    </div>
  </div>
  <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
    <!-- Kolom Kiri: Google Authenticator QR Decoder -->
    <div class="rounded-lg border border-gray-200 bg-white p-4 space-y-3 transition-all duration-300">
      <h3 class="text-sm font-semibold text-gray-800">Google Authenticator QR Decoder</h3>
      <p class="text-[11px] text-gray-600">Unggah gambar QR 2FA untuk mengekstrak akun dan secret-nya.</p>
      <input type="file" id="fileInput" accept="image/*" class="w-full px-2 py-1 border rounded focus:ring focus:ring-blue-400 text-sm transition-all duration-300">
      <pre id="output" class="p-2 bg-gray-900 text-green-400 rounded h-28 overflow-y-auto border border-gray-800 font-mono text-xs transition-all duration-300">Silakan Upload QR Google Authenticator</pre>
    </div>
    <!-- Kolom Kanan: Generator Bookmarklet -->
    <div class="rounded-lg border border-gray-200 bg-white p-4 space-y-3 transition-all duration-300">
      <h3 class="text-sm font-semibold text-gray-800">Generator Bookmarklet</h3>
      <p class="text-[11px] text-gray-600">Bookmarklet ini menghasilkan kode OTP sesuai secret yang Anda masukkan.</p>
      <div class="space-y-2">
        <div class="text-[11px] font-medium text-gray-500">Bookmarklet Kode OTP</div>
        <!-- Ganti bagian input secret -->
        <div class="relative">
          <input type="password" id="bookmarkletCode" placeholder="Kode Secret" class="w-full px-2 py-1 pr-8 border rounded focus:ring focus:ring-blue-400 text-sm transition-all duration-300">
          <button type="button" onclick="toggleSecret()" class="absolute right-2 top-1/2 -translate-y-1/2 text-xs text-gray-500 hover:text-gray-700 dark:text-gray-300 dark:hover:text-gray-100 transition-colors duration-200">üëÅÔ∏è</button>
        </div>
        <script>
        function toggleSecret() {
          const input = document.getElementById('bookmarkletCode');
          if (input.type === 'password') {
            input.type = 'text';
          } else {
            input.type = 'password';
          }
        }
        </script>
        <input type="text" id="bookmarkletNama" placeholder="Nama Bookmarklet" class="w-full px-2 py-1 border rounded focus:ring focus:ring-blue-400 text-sm transition-all duration-300">
      </div>
      <div class="flex items-center gap-3 text-xs">
        <span class="text-gray-500">Penggunaan OTP:</span>
        <label class="flex items-center gap-1 text-gray-700"><input class="accent-blue-600" type="radio" name="bmOption" value="kode2fa" checked> Dapodik</label>
        <label class="flex items-center gap-1 text-gray-700"><input class="accent-blue-600" type="radio" name="bmOption" value="infogtk"> InfoGtk</label>
      </div>
      <button onclick="generateBookmarklet()" class="w-full py-2 bg-gradient-to-r from-blue-600 to-indigo-600 text-white rounded shadow-sm hover:from-blue-700 hover:to-indigo-700 focus:ring focus:ring-blue-400 text-sm transition-all duration-300">Generate</button>
      <p class="text-xs text-gray-500">Bookmarklet: <a id="bookmarkletLink" href="#" target="_blank" class="text-blue-600 hover:underline truncate inline-block max-w-full align-middle transition-colors duration-200"></a></p>
    </div>
  </div>
</div>
<!-- Modal Notifikasi -->
<div id="appModal" class="fixed inset-0 z-50 hidden items-center justify-center transition-opacity duration-300">
  <div class="absolute inset-0 bg-black/50" onclick="closeModal()"></div>
  <div class="relative bg-white w-80 max-w-[90vw] rounded-lg shadow-lg p-4 transition-all duration-300 dark:bg-gray-800 dark:text-gray-200">
    <div id="appModalMessage" class="text-sm text-gray-700 dark:text-gray-200">Masukkan nama bookmark terlebih dahulu.</div>
    <div class="mt-4 text-right">
      <button type="button" class="px-3 py-1.5 bg-blue-600 text-white rounded hover:bg-blue-700 dark:bg-blue-500 dark:hover:bg-blue-600 text-sm transition-colors duration-200" onclick="closeModal()">OK</button>
    </div>
  </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/protobufjs/dist/protobuf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jsqr/dist/jsQR.js"></script>
<script>
// Dark mode toggle
document.getElementById('themeToggle').addEventListener('click', () => {
  document.documentElement.classList.toggle('dark');
  localStorage.setItem('theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light');
});
// Load saved theme
window.addEventListener('DOMContentLoaded', () => {
  if (localStorage.getItem('theme') === 'dark' || (!localStorage.getItem('theme') && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
    document.documentElement.classList.add('dark');
  } else {
    document.documentElement.classList.remove('dark');
  }
});

document.getElementById('fileInput').addEventListener('change', handleFile);

function handleFile(evt) {
    const file = evt.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function(e) {
        const img = new Image();
        img.onload = function() {
            const canvas = document.createElement('canvas');
            canvas.width = img.width;
            canvas.height = img.height;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0);
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const code = jsQR(imageData.data, imageData.width, imageData.height);

            if (code) {
                processQR(code.data);
            } else {
                document.getElementById('output').textContent = "‚ùå QR code tidak terbaca.";
            }
        };
        img.src = e.target.result;
    };
    reader.readAsDataURL(file);
}

function processQR(qrText) {
    try {
        if (qrText.startsWith("otpauth://")) {
            const url = new URL(qrText);
            const secret = url.searchParams.get("secret");
            const issuer = url.searchParams.get("issuer") || "(tidak ada)";
            const label = decodeURIComponent(url.pathname.replace(/^\/\//, ''));
            if (secret) {
                document.getElementById('output').textContent =
                    `üìå OTP Auth\n` +
                    `Nama   : ${label}\n` +
                    `Issuer : ${issuer}\n` +
                    `Secret : ${secret}`;
                const secretInput = document.getElementById('bookmarkletCode');
                if (secretInput) secretInput.value = secret;
            } else {
                document.getElementById('output').textContent = "‚ö†Ô∏è Secret tidak ditemukan di QR.";
            }
            return;
        }
        const url = new URL(qrText);
        let dataParam = url.searchParams.get("data");

        if (!dataParam) {
            document.getElementById('output').textContent = "‚ö†Ô∏è Parameter data= tidak ditemukan.";
            return;
        }

        dataParam = dataParam.replace(/ /g, '+').replace(/%20/g, '+').replace(/%2B/gi, '+');

        const binary = atob(dataParam);
        const bytes = new Uint8Array(binary.length);
        for (let i = 0; i < binary.length; i++) {
            bytes[i] = binary.charCodeAt(i);
        }

        const root = protobuf.Root.fromJSON({
            nested: {
                MigrationPayload: {
                    fields: {
                        otpParameters: { rule: "repeated", type: "OtpParameters", id: 1 },
                        version: { type: "int32", id: 2 },
                        batchSize: { type: "int32", id: 3 },
                        batchIndex: { type: "int32", id: 4 },
                        batchId: { type: "bytes", id: 5 }
                    }
                },
                OtpParameters: {
                    fields: {
                        secret: { type: "bytes", id: 1 },
                        name: { type: "string", id: 2 },
                        issuer: { type: "string", id: 3 },
                        algorithm: { type: "int32", id: 4 },
                        digits: { type: "int32", id: 5 },
                        type: { type: "int32", id: 6 },
                        counter: { type: "int64", id: 7 }
                    }
                }
            }
        });

        const MigrationPayload = root.lookupType("MigrationPayload");
        const payload = MigrationPayload.decode(bytes);

        if (!payload.otpParameters || payload.otpParameters.length === 0) {
            document.getElementById('output').textContent = "‚ö†Ô∏è Tidak ada akun ditemukan di payload migrasi.";
            return;
        }

        let result = "";
        let firstSecretBase32 = null;
        payload.otpParameters.forEach((param, i) => {
            const secretBase32 = base32Encode(param.secret);
            if (firstSecretBase32 === null) firstSecretBase32 = secretBase32;
            result += `üìå Akun ${i+1}\n`;
            result += `Nama   : ${param.name}\n`;
            result += `Issuer : ${param.issuer}\n`;
            result += `Secret : ${secretBase32}\n\n`;
        });

        document.getElementById('output').textContent = result;
        if (firstSecretBase32) {
            const secretInput = document.getElementById('bookmarkletCode');
            if (secretInput) secretInput.value = firstSecretBase32;
        }
    } catch (err) {
        document.getElementById('output').textContent = "‚ùå Error: " + err.message;
    }
}

function base32Encode(bytes) {
    const alphabet = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ234567';
    let bits = 0, value = 0, output = '';
    for (let i = 0; i < bytes.length; i++) {
        value = (value << 8) | bytes[i];
        bits += 8;
        while (bits >= 5) {
            output += alphabet[(value >>> (bits - 5)) & 31];
            bits -= 5;
        }
    }
    if (bits > 0) {
        output += alphabet[(value << (5 - bits)) & 31];
    }
    return output;
}

// Modal helper
function showModal(message) {
  const modal = document.getElementById('appModal');
  const messageEl = document.getElementById('appModalMessage');
  if (messageEl && typeof message === 'string' && message.length) {
    messageEl.textContent = message;
  }
  if (modal) {
    modal.classList.remove('hidden');
    modal.classList.add('flex');
  }
}
function closeModal() {
  const modal = document.getElementById('appModal');
  if (modal) {
    modal.classList.add('hidden');
    modal.classList.remove('flex');
  }
}
// Tutup modal dengan tombol Escape
window.addEventListener('keydown', function(e){
  if (e.key === 'Escape') closeModal();
});

function generateBookmarklet() {
    const code = document.getElementById("bookmarkletCode").value.trim();
	const namacode = document.getElementById("bookmarkletNama").value.trim();
	const selected2fa = document.querySelector('input[name="bmOption"]:checked').value;

	let jsCode;
	if (selected2fa === "infogtk") {
		// Fill 6 inputs with class .otp-input inside form#otpForm
		jsCode = `var secretKey="${code}";function base32Decode(e){for(var t=e.toUpperCase().replace(/=+$/,"").replace(/\\s+/g,""),r=0,n=0,a=[],o=0;o<t.length;o++){var c="ABCDEFGHIJKLMNOPQRSTUVWXYZ234567".indexOf(t[o]);if(-1===c)throw new Error("Invalid Base32 character: "+t[o]);n=n<<5|c,(r+=5)>=8&&(a.push(n>>>r-8&255),r-=8)}return new Uint8Array(a)}function intToBuffer(e){var t=new ArrayBuffer(8),r=new DataView(t),n=Math.floor(e/Math.pow(2,32)),a=e>>>0;return r.setUint32(0,n),r.setUint32(4,a),new Uint8Array(t)}function generateTOTP(e,t,r,n){t=t||6,r=r||30,n=n||"SHA-1";var a=base32Decode(e),o=Math.floor(Date.now()/1e3),c=intToBuffer(Math.floor(o/r));return crypto.subtle.importKey("raw",a,{name:"HMAC",hash:{name:n}},!1,["sign"]).then(function(e){return crypto.subtle.sign("HMAC",e,c)}).then(function(e){var r=new Uint8Array(e),n=15&r[r.length-1];return(((127&r[n])<<24|(255&r[n+1])<<16|(255&r[n+2])<<8|255&r[n+3])%Math.pow(10,t)).toString().padStart(t,"0")})}function fillOTPForm(otp){var f=document.getElementById("otpForm");if(!f)return;var ins=f.querySelectorAll(".otp-input");if(ins.length===6&&otp.length===6){for(var i=0;i<6;i++){ins[i].value=otp.charAt(i)}}}generateTOTP(secretKey).then(function(code){fillOTPForm(code)}).catch(function(err){alert("Error: "+err.message)});`;
	} else {
		// Default Dapodik: fill single element by id 'kode2fa'
		jsCode = `var secretKey="${code}";function base32Decode(e){for(var t=e.toUpperCase().replace(/=+$/,"").replace(/\\s+/g,""),r=0,n=0,a=[],o=0;o<t.length;o++){var c="ABCDEFGHIJKLMNOPQRSTUVWXYZ234567".indexOf(t[o]);if(-1===c)throw new Error("Invalid Base32 character: "+t[o]);n=n<<5|c,(r+=5)>=8&&(a.push(n>>>r-8&255),r-=8)}return new Uint8Array(a)}function intToBuffer(e){var t=new ArrayBuffer(8),r=new DataView(t),n=Math.floor(e/Math.pow(2,32)),a=e>>>0;return r.setUint32(0,n),r.setUint32(4,a),new Uint8Array(t)}function generateTOTP(e,t,r,n){t=t||6,r=r||30,n=n||"SHA-1";var a=base32Decode(e),o=Math.floor(Date.now()/1e3),c=intToBuffer(Math.floor(o/r));return crypto.subtle.importKey("raw",a,{name:"HMAC",hash:{name:n}},!1,["sign"]).then(function(e){return crypto.subtle.sign("HMAC",e,c)}).then(function(e){var r=new Uint8Array(e),n=15&r[r.length-1];return(((127&r[n])<<24|(255&r[n+1])<<16|(255&r[n+2])<<8|255&r[n+3])%Math.pow(10,t)).toString().padStart(t,"0")})}generateTOTP(secretKey).then(function(e){var el=document.getElementById("kode2fa");if(el)el.value=e}).catch(function(e){alert("Error: "+e.message)});`;
	}

    if (!code) {
		alert("Masukkan kode secret terlebih dahulu.");
        return;
    } else if (!namacode) {
        showModal("Masukkan nama bookmark terlebih dahulu.");
        return;
	}
    const bookmarklet = "javascript:(function(){" + encodeURIComponent(jsCode) + "})();";
    const link = document.getElementById("bookmarkletLink");
    link.href = bookmarklet;
    link.textContent = document.getElementById("bookmarkletNama").value;
}
</script>
</body>
</html>